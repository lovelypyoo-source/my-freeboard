<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>관리자 페이지</title>
<style>
/* 기존 관리자 스타일 그대로 사용 */
textarea { width: 100%; min-height: 80px; margin-bottom: 10px; }
.comment-box { margin-top: 10px; padding: 10px; background: #f4f4f4; border-radius: 8px; }
.comment-item { display: flex; align-items: center; justify-content: space-between; margin: 3px 0; }
.comment-item span { flex-grow: 1; }
</style>
<script>
// 세션 인증 확인
window.onload = function() {
  if (sessionStorage.getItem("adminAuth") !== "true") {
    alert("잘못된 접근입니다. 메인 페이지에서 로그인 후 이용하세요.");
    window.location.href = "index.html";
  }
};

// --- 안전한 날짜 파서 ---
function safeParseDate(val) {
  if (val == null) return null;
  if (typeof val === 'number') return new Date(val);
  if (typeof val === 'string') {
    const trimmed = val.trim();
    if (/^\d+$/.test(trimmed)) {
      const n = parseInt(trimmed, 10);
      const ms = trimmed.length < 13 ? n * 1000 : n;
      return new Date(ms);
    }
    const d1 = new Date(trimmed);
    if (!isNaN(d1)) return d1;
    const m1 = trimmed.match(/^(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})/);
    if (m1) return new Date(+m1[1], +m1[2]-1, +m1[3]);
    const m2 = trimmed.match(/^(\d{4})[\/\-.]\s*(\d{1,2})[\/\-.]\s*(\d{1,2})/);
    if (m2) return new Date(+m2[1], +m2[2]-1, +m2[3]);
  }
  return null;
}

let posts = JSON.parse(localStorage.getItem("posts") || "[]");

// --- createdAt 보정 ---
(function migrateCreatedAt(){
  let changed = false;
  posts.forEach(p => {
    const d = safeParseDate(p.createdAt);
    if (d) {
      const ms = d.getTime();
      if (p.createdAt !== ms) {
        p.createdAt = ms;
        changed = true;
      }
    } else {
      p.createdAt = Date.now();
      changed = true;
    }
  });
  if (changed) localStorage.setItem("posts", JSON.stringify(posts));
})();

function renderPosts() {
  const container = document.getElementById("postsContainer");
  container.innerHTML = "";

  const nowMs = Date.now();

  posts.forEach((p, index) => {
    // 안전하게 날짜 변환
    const ms = typeof p.createdAt === 'number'
      ? p.createdAt
      : (safeParseDate(p.createdAt)?.getTime() ?? Date.now());

    const postDate = new Date(ms);

    // 글이 1년 이내면 표시
    const diffInDays = (nowMs - ms) / (1000 * 3600 * 24);
    if (diffInDays > 365) return; // 1년 넘으면 제외

    const div = document.createElement("div");
    div.innerHTML = `
      <h2>글 번호 ${index+1}</h2>
      <textarea id="editContent_${p.id}">${p.content ?? ""}</textarea>
      <p>작성일: ${postDate.toLocaleDateString()}</p>
      <p>조회수: ${p.views ?? 0}</p>
      ...
    `;
    container.appendChild(div);
  });
}

function addComment(id) {
  const input = document.getElementById(`commentInput_${id}`);
  const post = posts.find(p => p.id == id);
  if (!post || !input.value.trim()) return;
  if (!Array.isArray(post.comments)) post.comments = [];
  post.comments.push(input.value.trim());
  savePosts();
  input.value = "";
  renderPosts();
}

function updateComment(postId, idx) {
  const post = posts.find(p => p.id == postId);
  if (!post || !Array.isArray(post.comments)) return;
  const input = document.getElementById(`commentEdit_${postId}_${idx}`);
  post.comments[idx] = input.value;
  savePosts();
  renderPosts();
}

function deleteComment(postId, idx) {
  const post = posts.find(p => p.id == postId);
  if (!post || !Array.isArray(post.comments)) return;
  post.comments.splice(idx,1);
  savePosts();
  renderPosts();
}

function savePost(id) {
  const post = posts.find(p => p.id == id);
  post.content = document.getElementById(`editContent_${id}`).value;
  savePosts();
  alert("저장 완료");
  renderPosts();
}

function deletePost(id) {
  if (!confirm("삭제하시겠습니까?")) return;
  posts = posts.filter(p => p.id != id);
  savePosts();
  renderPosts();
}

function savePosts() {
  localStorage.setItem("posts", JSON.stringify(posts));
}

function logout() {
  sessionStorage.removeItem("adminAuth");
  alert("로그아웃 되었습니다.");
  window.location.href = "index.html";
}

function createPost(content) {
  const newPost = {
    id: Date.now().toString(),
    content: content,
    comments: [],
    views: 0,
    createdAt: Date.now()
  };
  posts.push(newPost);
  savePosts();
  renderPosts();
}

document.addEventListener('DOMContentLoaded', renderPosts);
</script>
</head>
<body>
<h1>관리자 페이지 - 전체 게시판</h1>
<div id="postsContainer"></div>
<button onclick="logout()">로그아웃</button>
</body>
</html>
