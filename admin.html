<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>관리자 페이지</title>
<style>
/* 기존 관리자 스타일 그대로 사용 */
</style>
<script>
// 세션 인증 확인
window.onload = function() {
  if (sessionStorage.getItem("adminAuth") !== "true") {
    alert("잘못된 접근입니다. 메인 페이지에서 로그인 후 이용하세요.");
    window.location.href = "index.html";
  }
};

// --- 날짜 안전 파서: 다양한 문자열/숫자 형식을 Date로 변환 ---
function safeParseDate(val) {
  if (val == null) return null;

  // 숫자(ms) 또는 초/밀리초 숫자 문자열
  if (typeof val === 'number') return new Date(val);
  if (typeof val === 'string') {
    const trimmed = val.trim();

    // 순수 숫자만으로 이루어진 문자열이면 타임스탬프로 간주
    if (/^\d+$/.test(trimmed)) {
      const n = parseInt(trimmed, 10);
      const ms = trimmed.length < 13 ? n * 1000 : n; // 초 단위면 ms로 변환
      return new Date(ms);
    }

    // 브라우저 기본 파서 시도 (ISO 8601 등)
    const d1 = new Date(trimmed);
    if (!isNaN(d1)) return d1;

    // 'YYYY. M. D.' 또는 'YYYY. MM. DD.' 형태 (ko-KR 로케일 문자열) 처리
    const m1 = trimmed.match(/^(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})/);
    if (m1) return new Date(+m1[1], +m1[2] - 1, +m1[3]);

    // 'YYYY/MM/DD' 또는 'YYYY-MM-DD' 또는 'YYYY.MM.DD' 형태 처리
    const m2 = trimmed.match(/^(\d{4})[\/\-.]\s*(\d{1,2})[\/\-.]\s*(\d{1,2})/);
    if (m2) return new Date(+m2[1], +m2[2] - 1, +m2[3]);
  }
  return null; // 파싱 실패
}

// 저장소에서 글 불러오기
let posts = JSON.parse(localStorage.getItem("posts") || "[]");

// --- 마이그레이션: createdAt을 일괄적으로 "밀리초 숫자"로 맞춤 ---
(function migrateCreatedAt(){
  let changed = false;
  posts.forEach(p => {
    const d = safeParseDate(p.createdAt);
    if (d) {
      const ms = d.getTime();
      if (p.createdAt !== ms) {
        p.createdAt = ms;
        changed = true;
      }
    } else {
      // createdAt이 없거나 파싱 불가하면 현재 시각으로 보정
      p.createdAt = Date.now();
      changed = true;
      console.warn("createdAt가 없어 현재 시각으로 보정했습니다. post id:", p.id);
    }
  });
  if (changed) {
    localStorage.setItem("posts", JSON.stringify(posts));
  }
})();

function renderPosts() {
  const container = document.getElementById("postsContainer");
  container.innerHTML = "";

  const nowMs = Date.now();

  posts.forEach((p, index) => {
    // createdAt을 안전하게 밀리초 숫자로 보장
    const ms = typeof p.createdAt === 'number' ? p.createdAt : (safeParseDate(p.createdAt)?.getTime() ?? Date.now());
    const postDate = new Date(ms);

    const diffInDays = (nowMs - ms) / (1000 * 3600 * 24);
    if (diffInDays > 365) return; // 1년 지난 글은 표시하지 않음

    const div = document.createElement("div");
    div.innerHTML = `
      <h2>글 번호 ${index + 1}</h2>
      <textarea id="editContent_${p.id}">${p.content ?? ""}</textarea>
      <p>작성일: ${postDate.toLocaleDateString()}</p>
      <p>조회수: ${p.views ?? 0}</p>
      <div class="comments">
        <h4>댓글</h4>
        ${(Array.isArray(p.comments) ? p.comments : []).map(c => `<p>- ${c}</p>`).join('')}
        <input type="text" id="commentInput_${p.id}" placeholder="댓글 작성">
        <button onclick="addComment('${p.id}')">댓글 등록</button>
      </div>
      <button onclick="savePost('${p.id}')">저장</button>
      <button onclick="deletePost('${p.id}')">삭제</button>
    `;
    container.appendChild(div);
  });
}

function addComment(id) {
  const input = document.getElementById(`commentInput_${id}`);
  const post = posts.find(p => p.id == id);
  if (!post || !input.value.trim()) return;
  if (!Array.isArray(post.comments)) post.comments = [];
  post.comments.push(input.value.trim());
  savePosts();
  input.value = "";
  renderPosts();
}

function savePost(id) {
  const post = posts.find(p => p.id == id);
  post.content = document.getElementById(`editContent_${id}`).value;
  savePosts();
  alert("저장 완료");
  renderPosts();
}

function deletePost(id) {
  if (!confirm("삭제하시겠습니까?")) return;
  posts = posts.filter(p => p.id != id);
  savePosts();
  renderPosts();
}

function savePosts() {
  localStorage.setItem("posts", JSON.stringify(posts));
}

function logout() {
  sessionStorage.removeItem("adminAuth");
  alert("로그아웃 되었습니다.");
  window.location.href = "index.html";
}

// 게시글 작성 시 작성일을 "숫자 타임스탬프(ms)"로 저장
function createPost(content) {
  const newPost = {
    id: Date.now().toString(),
    content: content,
    comments: [],
    views: 0,
    createdAt: Date.now() // <- toISOString() 대신 숫자(ms)로 저장
  };
  posts.push(newPost);
  savePosts();
  renderPosts();
}

document.addEventListener('DOMContentLoaded', renderPosts);
</script>
</head>
<body>
<h1>관리자 페이지 - 전체 게시판</h1>
<div id="postsContainer"></div>
<button onclick="logout()">로그아웃</button>
</body>
</html>
