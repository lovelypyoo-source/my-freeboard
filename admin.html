<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>관리자 페이지</title>
<style>
body { font-family: Arial, sans-serif; padding:20px; background:#f9f9f9; }
h1 { text-align:center; margin-bottom:30px; }

table {
  width: 100%;
  border-collapse: collapse;
  background: #fff;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
th, td {
  border: 1px solid #ddd;
  padding: 10px;
  text-align: center;
}
th {
  background: #f2f2f2;
}
.comment-box {
  margin-top: 10px;
  text-align: left;
}
.comment-box p {
  margin: 3px 0;
}
.comment-input {
  width: 85%;
  padding: 5px;
}
button {
  margin: 2px;
  padding: 4px 8px;
  font-size: 13px;
}
</style>
<script>
// 세션 인증 확인
window.onload = function() {
  if (sessionStorage.getItem("adminAuth") !== "true") {
    alert("잘못된 접근입니다. 메인 페이지에서 로그인 후 이용하세요.");
    window.location.href = "index.html";
  }
}
</script>
</head>
<body>
<h1>관리자 페이지 - 게시판</h1>

<table id="postsTable">
  <thead>
    <tr>
      <th>번호</th>
      <th>제목</th>
      <th>작성자</th>
      <th>유형</th>
      <th>작성일</th>
      <th>조회수</th>
      <th>댓글/관리</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<button onclick="logout()">로그아웃</button>

<script>
let posts = JSON.parse(localStorage.getItem("posts") || "[]");

// 게시글 렌더링
function renderPosts() {
  const tbody = document.querySelector("#postsTable tbody");
  tbody.innerHTML = "";

  const currentDate = Date.now();
  const ONE_YEAR = 365 * 24 * 60 * 60 * 1000;

  posts
    .filter(p => (currentDate - (p.createdAt || p.id)) <= ONE_YEAR) // 1년 이내 글만
    .slice(-500) // 최대 500개
    .forEach((p, index) => {
      const postDate = new Date(p.createdAt || p.id);
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${index + 1}</td>
        <td>${p.title || "(제목 없음)"}</td>
        <td>${p.author || "익명"}</td>
        <td>${p.type || "자유"}</td>
        <td>${postDate.toLocaleString()}</td>
        <td>${p.views || 0}</td>
        <td>
          <div class="comment-box" id="comments_${p.id}">
            ${p.comments.map((c,i)=>`
              <p>
                ${c} 
                <button onclick="editComment('${p.id}', ${i})">수정</button>
                <button onclick="deleteComment('${p.id}', ${i})">삭제</button>
              </p>
            `).join("")}
          </div>
          <input type="text" id="commentInput_${p.id}" class="comment-input" placeholder="댓글 작성">
          <button onclick="addComment('${p.id}')">등록</button><br>
          <button onclick="deletePost('${p.id}')">글 삭제</button>
        </td>
      `;

      tbody.appendChild(tr);
    });
}

function addComment(id) {
  const input = document.getElementById(`commentInput_${id}`);
  const post = posts.find(p => p.id == id);
  if (!post || !input.value.trim()) return;
  post.comments.push(input.value.trim());
  savePosts();
  renderPosts();
}

function editComment(postId, commentIndex) {
  const post = posts.find(p => p.id == postId);
  const newComment = prompt("댓글 수정:", post.comments[commentIndex]);
  if (newComment !== null && newComment.trim() !== "") {
    post.comments[commentIndex] = newComment.trim();
    savePosts();
    renderPosts();
  }
}

function deleteComment(postId, commentIndex) {
  const post = posts.find(p => p.id == postId);
  if (confirm("댓글을 삭제하시겠습니까?")) {
    post.comments.splice(commentIndex, 1);
    savePosts();
    renderPosts();
  }
}

function deletePost(id) {
  if (!confirm("글을 삭제하시겠습니까?")) return;
  posts = posts.filter(p => p.id != id);
  savePosts();
  renderPosts();
}

function savePosts() {
  localStorage.setItem("posts", JSON.stringify(posts));
}

function logout() {
  sessionStorage.removeItem("adminAuth");
  alert("로그아웃 되었습니다.");
  window.location.href = "index.html";
}

renderPosts();
</script>
</body>
</html>
